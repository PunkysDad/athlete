FROM node:20-alpine

WORKDIR /app

# Install system dependencies
RUN apk add --no-cache git bash curl

# Install Expo CLI globally
RUN npm install -g @expo/cli@0.18.0

# Create app directory and set proper ownership
RUN mkdir -p /app && chown -R node:node /app

# Copy package files as root, then fix ownership
COPY package.json ./
COPY package-lock.json* ./
RUN chown -R node:node /app

# Switch to node user
USER node

# Install dependencies with legacy peer deps
RUN npm install --legacy-peer-deps
RUN npx expo install --fix

# Copy source code
COPY --chown=node:node . .

# Expose ports
EXPOSE 19000 19001 19002 8081

CMD ["npx", "expo", "start", "--web", "--host", "lan"]