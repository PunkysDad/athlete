FROM node:20-alpine

WORKDIR /app

# Install system dependencies
RUN apk add --no-cache \
    git \
    bash \
    curl \
    && rm -rf /var/cache/apk/*

# Install global packages
RUN npm install -g @expo/cli @react-native-community/cli

# Create app directory and set permissions
RUN mkdir -p /app && chown -R node:node /app

# Copy package files first
COPY --chown=node:node package.json ./
COPY --chown=node:node package-lock.json* ./

# Switch to node user
USER node

# Install dependencies with legacy peer deps flag
RUN npm install --legacy-peer-deps

# Copy source code
COPY --chown=node:node . .

# Expose ports
EXPOSE 19000 19001 19002 8081

# FIXED: Use "lan" instead of "0.0.0.0"
CMD ["npx", "expo", "start", "--web", "--host", "lan"]